# name: Hprofile Actions               
# on: workflow_dispatch                
# jobs:                                
#   Testing:                           
#     runs-on: ubuntu-latest           
#     steps:                           
#       - name: Code checkout          
#         uses: actions/checkout@v4   

#       - name: Maven test             
#         run: mvn test                
      
#       - name: Checkstyle             
#         run: mvn checkstyle:checkstyle   

#       - name: Set Java 11
#         uses: actions/setup-java@v3
#         with:
#           distribution: 'temurin'
#           java-version: '11'

#       - name: Setup SonarQube
#         uses: warchant/setup-sonar-scanner@v7

#       - name: SonarQube Scan
#         run: sonar-scanner
#           -Dsonar.host.url=${{ secrets.SONAR_URL }}
#           -Dsonar.login=${{ secrets.SONAR_TOKEN }}
#           -Dsonar.organization=${{ secrets.SONAR_ORGANIZATION }}
#           -Dsonar.projectKey=${{ secrets.SONAR_PROJECT_KEY }}
#           -Dsonar.sources=src/
#           -Dsonar.junit.reportsPath=target/surefire-reports/
#           -Dsonar.jacoco.reportsPath=target/jacoco.exec
#           -Dsonar.java.checkstyle.reportPaths=target/checkstyle-result.xml


name: Hprofile Actions                                   # ชื่อ workflow

on:
  push:                                                  # ให้รันอัตโนมัติเมื่อมีการ push
    branches: [ main ]                                   # เฉพาะ branch main
  pull_request:                                          # และเมื่อมี PR เข้ามา

jobs:
  sonarcloud:
    runs-on: ubuntu-latest                               # ใช้ runner Ubuntu

    steps:
      - name: Checkout code
        uses: actions/checkout@v4                        # ดึงโค้ดจาก repo
        with:
          fetch-depth: 0                                 # ดึง history ทั้งหมด (ดีต่อ Sonar สำหรับ compare)

      - name: Set up Java
        uses: actions/setup-java@v4                      # ติดตั้ง JDK
        with:
          distribution: 'temurin'                        # ใช้ Temurin
          java-version: '17'                             # ใช้ Java 17 (หรือ 11 ก็ได้ ถ้าโปรเจกต์บังคับ)

      - name: Build & Test (Maven verify)
        run: mvn -B verify                               # compile + test + สร้าง class + reports ครบ (แก้ปัญหา sonar.java.binaries)

      - name: SonarCloud Scan
        uses: SonarSource/sonarcloud-github-action@v2    # ใช้ action official ของ SonarCloud
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}      # token ของ GitHub (ให้ Sonar อ่าน PR / commit ได้)
          SONAR_TOKEN:  ${{ secrets.SONAR_TOKEN }}       # token ของ SonarCloud (ตัวเดียวกับที่น้องสร้างไว้แล้ว)
          # ไม่ต้องใส่ SONAR_URL, SONAR_ORGANIZATION, SONAR_PROJECT_KEY ก็ได้
          # เพราะ SonarCloud จะรู้เองจากการเชื่อม GitHub App + project ที่สร้างไว้
